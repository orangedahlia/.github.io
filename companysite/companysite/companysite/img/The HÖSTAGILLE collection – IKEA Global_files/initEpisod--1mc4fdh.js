(function(){"use strict";const v={strictlyNecessary:"C0001",analytical:"C0002",functional:"C0003",marketing:"C0004",socialMedia:"C0005"},V=e=>(window.OnetrustActiveGroups||"").split(",").includes(e);let D={};const N=(e,t,s)=>{D[e]={client:t,server:s}},z=(e,t)=>{const{client:s,server:n}=D[t]||{};return!s||!n||!e?null:q(n,e.getTime()-s.getTime())},q=(e,t)=>e?!t||t<0?new Date(e.getTime()+1).toISOString():new Date(e.getTime()+t).toISOString():null,M=e=>new URLSearchParams(window.location.search).get(e),E=e=>{const t=new Uint8Array(e/2);crypto.getRandomValues(t);let s="";for(let n=0;n<t.length;++n)s+=("0"+t[n].toString(16)).slice(-2);return s},P=e=>{var s;return(s=document.cookie.split("; ").find(n=>n.startsWith(`${e}=`)))==null?void 0:s.split("=")[1]},B=(e,t)=>t?parseInt(e):e?parseInt(e)+1:1,H=(e,t,s)=>s?`${e}.${t}`:`${new Date().getTime()}.${E(8)}`,W=(e,t)=>{const s=P("episod_session_id"),n=new Date(parseInt(t)).toUTCString(),i=30*60*1e3;let r,a,o,l,c=!1;s&&([r,a,o,l]=s.split("."),c=!!l&&new Date().getTime()-l<i);const u=H(r,a,c),p=B(o,c),d=new Date().getTime(),y=`${u}.${p}.${d}`;return document.cookie=`episod_session_id=${y}; expires=${n}; Secure; path=/; domain=${e}`,{sessionId:u,sessionStart:!c,sessionNumber:p}},F=e=>{const t=P("episod_id"),s=M("episod_test"),n=13*30*24*60*60*1e3,i=new Date().getTime();let r,a,o,l,c,u,p=!1;if(t){if([r,a,o,l]=t.split("."),o){const k=parseInt(o);Number.isInteger(k)?p=!0:u=o}if(l){const k=parseInt(l);Number.isInteger(k)||(u=l)}if(!p&&(!s||u===s))return c=parseInt(r)+n,{clientId:`${r}.${a}`,endDate:c,testUser:u}}let d,y;const R=()=>{c=i+n,d=`${i}.${E(8)}`,y=!0};r&&a?(c=parseInt(r)+n,c<i?R():d=`${r}.${a}`):R();let m,w;s?s==="delete"?m=d:(w=s,m=`${d}.${w}`):u?(w=u,m=`${d}.${w}`):m=d;const ce=new Date(c).toUTCString();return document.cookie=`episod_id=${m}; expires=${ce}; Secure; path=/; domain=${e}`,{clientId:d,endDate:c,testUser:w,firstVisit:y}},f=(e,t)=>{const s={...e};for(const n in t)t.hasOwnProperty(n)&&(Array.isArray(t[n])?Array.isArray(e[n])?s[n]=[...e[n],...t[n]]:s[n]=[...t[n]]:typeof t[n]=="object"&&t[n]!==null&&e[n]?s[n]=f(e[n],t[n]):s[n]=t[n]);return s},G=()=>{const e=typeof navigator<"u"?navigator.language:void 0;return e?e.toLowerCase():null},J=()=>new Date().getTimezoneOffset(),Q=()=>decodeURIComponent(window.location.href).trim(),K=()=>document.referrer?decodeURIComponent(document.referrer).trim():null,X=()=>document.title,_=async e=>{let t={};for(let s in e)if(typeof e[s]=="function")t[s]=await e[s]();else if(Array.isArray(e[s])){t[s]=[];for(let n=0;n<e[s].length;n++)typeof e[s][n]=="function"?t[s].push(await e[s][n]()):typeof e[s][n]=="object"&&e[s][n]!==null?t[s].push(await _(e[s][n])):t[s].push(e[s][n])}else typeof e[s]=="object"&&e[s]!==null?t[s]=await _(e[s]):t[s]=e[s];return t},I=e=>Array.isArray(e)?e.filter(t=>t!==null&&t!=="").map(t=>typeof t=="object"?I(t):t):(Object.keys(e).forEach(t=>{e[t]&&typeof e[t]=="object"?e[t]=I(e[t]):(e[t]===null||e[t]==="")&&delete e[t]}),e),Y=()=>window.innerHeight,Z=()=>window.innerWidth,A=(e,t)=>{const s={};for(const n in e)if(!t.hasOwnProperty(n))s[n]=e[n];else if(typeof e[n]=="object"&&e[n]!==null&&typeof t[n]=="object"&&t[n]!==null){const i=A(e[n],t[n]);Object.keys(i).length>0&&(s[n]=i)}else e[n]!==t[n]&&(s[n]=e[n]);for(const n in t)t.hasOwnProperty(n)&&!e.hasOwnProperty(n)&&(s[n]=t[n]);return s},x=e=>{const t={},[s,...n]=e;for(const i in s)if(s.hasOwnProperty(i)){const r=s[i];if(typeof r=="object"&&r!==null&&!Array.isArray(r)){const a=n.map(o=>o[i]).filter(o=>typeof o=="object"&&o!==null);if(a.length===n.length){const o=x([r,...a]);Object.keys(o).length>0&&(t[i]=o)}}else n.every(a=>a[i]===r)&&(t[i]=r)}return t},b=e=>{const t=e.map(i=>{const{eventTimestamp:r,...a}=i,o=z(r,i.pageview_id);return f(a,{server_timestamp:o})});if(t.length===1)return{commons:{},events:t};const s=x(t),n=t.map(i=>A(s,i));return{commons:s,events:n}};let $={schema_version:"2.4.0",episod_client_version:"2.0.0",event_referring_location:K,event_location:Q,event_details:{location_title:X},client_details:{user_agent:typeof navigator<"u"?navigator.userAgent:null,viewport_height:Y,viewport_width:Z,client_language:G,local_time_zone:J}};const j=e=>{$=f($,e)},ee=()=>$;let O;const te=e=>{O=e},T=()=>{if(!O)throw console.error("Episod config not set. Please run init() first."),new Error("Episod config not set. Please run init() first.");return O};let C=[];const ne=()=>C,se=e=>{C=e},ie=e=>{C.push(e)};let h=null;const L=(e,t)=>{re(),h=setTimeout(e,t)},re=()=>{h&&(clearTimeout(h),h=null)},S=async(e,t={})=>{let s;try{s=T()}catch{return}const{url:n,xClientId:i}=s;if(!n||!i){console.error("Episod requires url and xClientId to dispatch");return}const{expectResponse:r=!1}=t,a={method:"POST",headers:{"Content-Type":"application/json","x-client-id":i},body:JSON.stringify(e),keepalive:!0};if(r){const o=await fetch(n,a);if(!o.ok){const c=`An error has occured: ${o.status}`;throw new Error(c)}const{serverTimestamp:l}=await o.json();return l}fetch(n,a)},g=(e={})=>{const{pageview_id:t}=e,s=ne();if(s.length){const n=[],i=[];s.forEach(r=>{t&&t===r.pageview_id?n.push(r):i.push(r)}),i.length&&S(b(i)),se(n)}L(g,1e3*60)},oe=e=>{const{cookieDomain:t,url:s,xClientId:n,commons:i,batch:r=!1}=e;if(!t||!s||!n){console.error("Episod requires cookieDomain, url, and xClientId to initialize");return}te({cookieDomain:t,url:s,xClientId:n,batch:r}),i&&j(i),r&&(window.addEventListener("beforeunload",g),window.addEventListener("pagehide",g),window.addEventListener("visibilitychange",g),L(g,1e3*60))},U=async(e,t={})=>{let s;try{s=T()}catch{return}const{batch:n}=t,i=await ae(e);if(s.batch&&n!==!1)if(i.event_name==="pageview"){g({pageview_id:i.pageview_id});const r=await S(i,{expectResponse:!0});N(i.pageview_id,new Date,new Date(r))}else ie(f(i,{eventTimestamp:new Date}));else S(i)},ae=async e=>{let t;try{t=T()}catch{return}const{cookieDomain:s}=t,n=ee(),{clientId:i,endDate:r,testUser:a,firstVisit:o}=F(s),{sessionId:l,sessionStart:c,sessionNumber:u}=W(s,r);return I(await _(f(f(n,{client_id:i,client_new:o,session_id:l,session_start:c,session_number:u,episod_test:!!a,client_details:{episod_test_id:a}}),e)))};(function(){const s=(window.ikeaExternalScriptOptions||{}).episod||{},{cookieDomain:n,url:i,xClientId:r,event_origin:a}=s;window.episodSendEvent=U;const o=()=>new Date().getTime()+"."+Math.random().toString(36).substring(5),l=()=>document.querySelector("html").getAttribute("lang"),c=p=>()=>V(p),u={pageview_id:o(),market_code:"global",event_origin:a||"web",event_origin_team:"icg",event_details:{location_language:l},client_details:{consent:{marketing:c(v.marketing),analytics:c(v.analytical),personalization:c(v.functional)}}};oe({cookieDomain:n,url:i,xClientId:r,commons:u}),U({event_name:"pageview"})})()})();
